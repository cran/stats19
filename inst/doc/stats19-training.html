<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Robin Lovelace, Malcolm Morgan &amp; Andrea Gilardi" />


<title>Introduction to R for road safety: an introduction to R and practical exercises</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">

div.csl-bib-body { }
div.csl-entry {
clear: both;
}
.hanging div.csl-entry {
margin-left:2em;
text-indent:-2em;
}
div.csl-left-margin {
min-width:2em;
float:left;
}
div.csl-right-inline {
margin-left:2em;
padding-left:1em;
}
div.csl-indent {
margin-left: 2em;
}
</style>

<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Introduction to R for road safety: an
introduction to R and practical exercises</h1>
<h3 class="subtitle">Practical exercises based on UK data from the
stats19 package, developed by the Institute for Transport Studies,
University of Leeds</h3>
<h4 class="author">Robin Lovelace, Malcolm Morgan &amp; Andrea
Gilardi</h4>



<div id="note" class="section level1">
<h1>Note</h1>
<p>This introductory practical vignette has largely been replaced by the
workbook “Reproducible Road Safety Research with R”, which can be found
at <a href="https://itsleeds.github.io/rrsrr/" class="uri">https://itsleeds.github.io/rrsrr/</a> and as a PDF at <a href="https://www.racfoundation.org/wp-content/uploads/Reproducible_road_safety_research_with_R_Lovelace_December_2020.pdf">racfoundation.org</a>
<span class="citation">(Lovelace 2020)</span>. That workbook is more
comprehensive than the content in this tutorial and is the recommended
place to learn about using R for reproducible road safety research.</p>
</div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This document provides information, code and exercises to test and
improve your R skills with an emphasis on road safety research. It was
initially developed to support a <a href="https://www.racfoundation.org/introduction-to-r-for-road-safety">2
day course</a>. The course is based on open road crash records from the
<strong>stats19</strong> package <span class="citation">(Lovelace et al.
2019)</span>. However, the content should be of use for anyone working
with road crash data that has (at a minimum):</p>
<ul>
<li>A timestamp</li>
<li>A location (or address that can be geocoded)</li>
<li>Attribute data, such as severity of crash, mode of vehicles involved
etc.</li>
</ul>
<p>You should type, run and ensure you understand each line of code in
this document.</p>
<p>Code and data supporting the content can be found in the package’s
GitHub repo at <a href="https://github.com/ropensci/stats19/">github.com/ropensci/stats19</a>.
The ‘<a href="https://github.com/ropensci/stats19/issues">issue
tracker</a>’ associated with that repo is a good place to ask questions
about the course.</p>
<div id="prerequisites" class="section level2">
<h2>Prerequisites</h2>
<p>If you are not experienced with R, it is strongly advised that you
read-up on and more importantly <strong>test out</strong> R and RStudio
before attempting analyse road crash data with R. See the
<code>stats19-training-setup</code> vignette at <a href="https://docs.ropensci.org/stats19/articles/stats19-training-setup.html" class="uri">https://docs.ropensci.org/stats19/articles/stats19-training-setup.html</a>
for guidance on getting started with R, RStudio and installing R
packages.</p>
<p>The completing the course requires that the following packages, which
can be installed with <code>install.packages()</code>, can be loaded as
follows:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(pct)      <span class="co"># access travel data from DfT-funded PCT project </span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(sf)       <span class="co"># spatial vector data classes</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(stats19)  <span class="co"># get stats19 data</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(stplanr)  <span class="co"># transport planning tools</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">library</span>(tidyverse)<span class="co"># packages for &#39;data science&#39;</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">library</span>(tmap)     <span class="co"># interactive maps</span></span></code></pre></div>
<p>You should type, run and ensure you understand each line of code in
this document.</p>
</div>
</div>
<div id="r-and-rstudio" class="section level1">
<h1>R and RStudio</h1>
<p>The learning outcomes of this first session are to learn: RStudio
main features and scripts, R objects and functions, subsetting, basic
plotting, and getting help.</p>
<p>The first exercise is to open up RStudio and take a look around and
identify the main components, shown in the figure below. <strong>Explore
each of the main components of RStudio.</strong> Try changing the Global
Settings (in the Tools menu) and see RStudio’s short cuts by pressing
<code>Alt-Shift-K</code> (or <code>Option+Shift+K</code> on Mac).</p>
<div id="projects-and-scripts" class="section level2">
<h2>Projects and scripts</h2>
<p>Projects are a way to organise related work together. Each project
has its own folder and Rproj file. <strong>Advice: always working from
projects will make your life easier!</strong> Start a new project
with:</p>
<blockquote>
<p>File &gt; New Project You can choose to create a new directory
(folder) or associate a project with an existing directory. Make a new
project called stats1-course and save it in a sensible place on your
computer. Notice that stats1-course now appears in the top right of
RStudio.</p>
</blockquote>
<p>Scripts are the files where R code is stored. <strong>Keeping your
code in sensibly named, well organised and reproducible scripts will
make your life easier:</strong> you could simply type all our code into
the console, but that require retyping commands each time you run it.
Instead, code that you want to keep and share should be saved script
files, plain text files that have the <code>.R</code> extension.</p>
<p>Make a new script with Flie &gt; New File &gt; Rscript or
Ctrl+Shift+N</p>
<p>Save the script and give it a sensible name like
<code>stats19-lesson-1.R</code> with File &gt; Save, the save button on
the toolbar, or Ctrl+S.</p>
<p><strong>Pro tip:</strong> You can also create new R scripts by typing
and running this command in the R console:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">file.edit</span>(<span class="st">&quot;stats19-lesson-1.R&quot;</span>)</span></code></pre></div>
<p>Keeping scripts and other files associated with a project in a single
folder per project (in an RStudio project) will help you find things you
need and develop an efficient workflow.</p>
</div>
<div id="writing-and-running-code" class="section level2">
<h2>Writing and running code</h2>
<p>Let’s start with some basic R operations. Write this code into your
new <code>stats19-lesson-1.R</code> R script and execute the result
line-by-line by pressing Ctrl+Enter</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>x <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">9</span>, <span class="dv">18</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="fu">plot</span>(x, y)</span></code></pre></div>
<p>This code creates two objects, both are vectors of 5 elements, and
then plots them (bonus: check their length using the
<code>length()</code> function). Save the script by pressing Ctrl+S.</p>
<p>There are several ways to run code within a script and it is worth
becoming familiar with each. Try running the code you saved in the
previous section using each of these methods:</p>
<ol style="list-style-type: decimal">
<li>Place the cursor in different places on each line of code and press
<code>Ctrl+Enter</code> to run that line of code.</li>
<li>Highlight a block of code or part of a line of code and press
<code>Ctrl+Enter</code> to run the highlighted code.</li>
<li>Press <code>Ctrl+Shift+Enter</code> to run all the code in a
script.</li>
<li>Press the Run button on the toolbar to run all the code in a
script.</li>
<li>Use the function <code>source()</code> to run all the code in a
script e.g. <code>source(&quot;stats19-lesson-1.R&quot;)</code>
<!-- (but don't create an infinite loop!) --></li>
</ol>
<p><strong>Pro tip:</strong> Try jumping between the console and the
source editor by pressing Ctl+1 and Ctl+2.</p>
</div>
<div id="viewing-objects" class="section level2">
<h2>Viewing Objects</h2>
<p>Create new objects by typing and running the following code chunk in
a new script, e.g. called <code>objects.R</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>vehicle_type <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;car&quot;</span>, <span class="st">&quot;bus&quot;</span>, <span class="st">&quot;tank&quot;</span>)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>casualty_type <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;pedestrian&quot;</span>, <span class="st">&quot;cyclist&quot;</span>, <span class="st">&quot;cat&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>casualty_age <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">20</span>, <span class="at">to =</span> <span class="dv">60</span>, <span class="at">by =</span> <span class="dv">20</span>)</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>dark <span class="ot">=</span> <span class="fu">sample</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>), <span class="at">size =</span> <span class="dv">3</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>small_matrix <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">24</span>, <span class="at">nrow =</span> <span class="dv">12</span>)</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>crashes <span class="ot">=</span> <span class="fu">data.frame</span>(vehicle_type, casualty_type, casualty_age, dark)</span></code></pre></div>
<p>We can view the objects in a range of ways:</p>
<ol style="list-style-type: decimal">
<li>Type the name of the object into the console,
e.g. <code>crashes</code> and <code>small_matrix</code>, and run that
code. Scroll up to see the numbers that didn’t fit on the screen.</li>
<li>Use the <code>head()</code> function to view just the first 6 rows
e.g. <code>head(small_matrix)</code></li>
<li>Bonus: use the <code>n</code> argument in the previous function call
to show only the first 2 rows of <code>small_matrix</code></li>
<li>Click on the <code>crashes</code> object in the environment tab to
View it in a spreadsheet.</li>
<li>Run the command <code>View(vehicle_type)</code>. What just
happened?</li>
</ol>
<p>We can also get an overview of an object using a range of functions,
including <code>summary()</code>, <code>class()</code>,
<code>typeof()</code>, <code>dim()</code>, and
<code>length()</code>.</p>
<p>You can, for example, view a summary of the <code>casualty_age</code>
variable by running the following line of code:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">summary</span>(casualty_age)</span></code></pre></div>
<p><strong>Exercise</strong> try these functions on each of the objects,
what results do they give?</p>
<p><strong>Bonus</strong>: Find out the class of the column
<code>vehicle_type</code> in the data frame <code>crashes</code> with
the command <code>class(crashes$vehicle_type)</code>. Why has it
changed? Create a new object called <code>crashes_char</code> that keeps
the class of the character vectors intact by using the function
<code>tibble::tibble()</code> (see <a href="https://tibble.tidyverse.org/">tibble.tidyverse.org</a> and
Section 4 for details).</p>
</div>
<div id="autocompletion" class="section level2">
<h2>Autocompletion</h2>
<p>RStudio can help you write code by autocompleting it. RStudio will
look for similar objects and functions after typing the first three
letters of a name.</p>
<p>When there is more than one option you can select from the list using
the mouse or arrow keys. Within a function, you can get a list of
arguments by pressing Tab.</p>
</div>
<div id="getting-help" class="section level2">
<h2>Getting help</h2>
<p>Every function in R has a help page. You can view the help using
<code>?</code> for example <code>?sum</code>. Many packages also contain
vignettes, these are long form help documents containing examples and
guides. <code>vignette()</code> will show a list of all the vignettes
available, or you can show a specific vignette for example
<code>vignette(topic = &quot;sf1&quot;, package = &quot;sf&quot;)</code>.</p>
</div>
<div id="commenting-code" class="section level2">
<h2>Commenting Code</h2>
<p>It is good practice to use comments in your code to explain what it
does. You can comment code using <code>#</code></p>
<p>For example:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Create vector objects (a whole line comment)</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>x <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span> <span class="co"># a seqence of consecutive integers (inline comment)</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">9</span>, <span class="fl">18.1</span>) </span></code></pre></div>
<p>You can comment/uncomment a whole block of text by selecting it and
using <code>Ctrl+Shift+C</code>.
<!-- not sure about the next statement so commenting out (RL) -->
<!-- and you can reformat a block of code using `Ctrl+Shift  + /`.  --></p>
<p><strong>Pro tip:</strong> You can add a comment section using Ctrl +
Shift + R</p>
</div>
<div id="the-global-environment" class="section level2">
<h2>The global environment</h2>
<p>The Environment tab shows all the objects in your environment, this
includes datasets, parameters, and any functions you have created. By
default, new objects appear in the Global Environment but you can see
other environments with the drop-down menu. For example, each package
has its own environment.</p>
<p>Sometimes you wish to remove things from your environment, perhaps
because you no longer need them or things are getting cluttered.</p>
<p>You can remove an object with the <code>rm()</code> function
e.g. <code>rm(x)</code> or <code>rm(x, y)</code> or you can clear your
whole environment with the broom button on the Environment Tab.</p>
<ol style="list-style-type: decimal">
<li>Remove the object <code>x</code> that was created in a previous
section.</li>
<li>What happens when you try to print the <code>x</code> by entering it
into the console?</li>
<li>Try running the following commands in order:
<code>save.image(); rm(list = ls()); load(&quot;.RData&quot;)</code>. What
happened?</li>
<li>How big (how many bytes) is the <code>.RData</code> file in your
project’s folder?</li>
<li>Tidy up by removing the <code>.Rdata</code> file with
<code>file.remove(&quot;.Rdata&quot;)</code>.</li>
</ol>
</div>
<div id="debugging-code" class="section level2">
<h2>Debugging Code</h2>
<p>All the code shown so far is reproducible. To test RStudio’s
debugging features, let’s write some code that fails, as illustrated in
the figure below.</p>
<ol style="list-style-type: decimal">
<li>What is the problem with the code shown in the figure?</li>
<li>Create other types of error in the code you have run (e.g. no
symetrical brackets and other typos)</li>
<li>Does RStudio pick up on the errors? And what happens when you try to
run buggy code?</li>
</ol>
<p><strong>Always address debugging prompts to ensure your code is
reproducible</strong></p>
</div>
<div id="saving-r-objects" class="section level2">
<h2>Saving R objects</h2>
<p>We have already seen that you can save R scripts. You can also save
individual R objects in the RDS format.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">saveRDS</span>(crashes, <span class="st">&quot;crashes.Rds&quot;</span>)</span></code></pre></div>
<p>We can also read back in our data.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>crashes2 <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="st">&quot;crashes.Rds&quot;</span>)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="fu">identical</span>(crashes, crashes2)</span></code></pre></div>
<p>R also supports many other formats, including CSV files, which can be
created and imported with the functions <code>readr::read_csv()</code>
and <code>readr::write_csv()</code> (see also the <a href="https://readr.tidyverse.org/">readr</a> package).</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">write_csv</span>(crashes, <span class="st">&quot;crashes.csv&quot;</span>)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>crashes3 <span class="ot">=</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">&quot;crashes.csv&quot;</span>)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="fu">identical</span>(crashes3, crashes) </span></code></pre></div>
<p>Notice that <code>crashes3</code> and <code>crashes</code> are not
identical, what has changed? Hint: read the help page associated with
<code>?readr::write_csv</code>.</p>
</div>
</div>
<div id="manipulating-r-objects" class="section level1">
<h1>Manipulating R objects</h1>
<div id="subsetting-by-index-or-name" class="section level2">
<h2>Subsetting by index or name</h2>
<p>Subsetting returns part of an R object. It can be done by providing
numbers representing the positions of the elements we want (e.g. the
2<sup>nd</sup> element) or with a logical vector, with values associated
with <code>TRUE</code> returned. Two dimension object such as matrices
and data frames can be subset by rows and columns. Subsetting in base R
is done with square brackets <code>[]</code> after the name of an
object. <strong>Run the following commands to practice
subsetting.</strong></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>casualty_age[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>] <span class="co"># second and third casualty_age</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>crashes[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), ] <span class="co"># first and second row of crashes</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>crashes<span class="sc">$</span>vehicle_type <span class="co"># returns just one column</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>crashes[, <span class="fu">c</span>(<span class="st">&quot;casualty_type&quot;</span>, <span class="st">&quot;casualty_age&quot;</span>)] <span class="co"># first and third columns</span></span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Use the <code>$</code> operator to print the <code>dark</code>
column of <code>crashes</code>.</li>
<li>Subset the crashes with the <code>[,]</code> syntax so that only the
first and third columns of <code>crashes</code> are returned.</li>
<li>Return the 2<sup>nd</sup> row and the 3<sup>rd</sup> column of the
<code>crashes</code> dataset.</li>
<li>Return the 2<sup>nd</sup> row and the columns 2:3 of the
<code>crashes</code> dataset.</li>
<li><strong>Bonus</strong>: what is the <code>class()</code> of the
objects created by each of the previous exercises?</li>
</ol>
</div>
<div id="subsetting-by-values" class="section level2">
<h2>Subsetting by values</h2>
<p>It is also possible to subset objects by the values of their
elements. This works because the <code>[</code> operator accepts logical
vectors returned by queries such as ‘is it less than 3?’
(<code>x &lt; 3</code> in R) and ‘was it light?’
(<code>crashes$dark == FALSE</code>), as demonstrated below:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>x[<span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span>)] <span class="co"># 1st, 3rd, and 5th element in x</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>x[x <span class="sc">==</span> <span class="dv">5</span>] <span class="co"># only when x == 5 (notice the use of double equals)</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>x[x <span class="sc">&lt;</span> <span class="dv">3</span>] <span class="co"># less than 3</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>x[x <span class="sc">&lt;</span> <span class="dv">3</span>] <span class="ot">=</span> <span class="dv">0</span> <span class="co"># assign specific elements</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>casualty_age[casualty_age <span class="sc">%%</span> <span class="dv">6</span> <span class="sc">==</span> <span class="dv">0</span>] <span class="co"># just the ages that are a multiple of 6</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>crashes[crashes<span class="sc">$</span>dark <span class="sc">==</span> <span class="cn">FALSE</span>, ]</span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Subset the <code>casualty_age</code> object using the inequality
(<code>&lt;</code>) so that only elements less than 50 are
returned.</li>
<li>Subset the <code>crashes</code> data frame so that only tanks are
returned using the <code>==</code> operator.</li>
<li><strong>Bonus</strong>: assign the age of all tanks to 61.</li>
</ol>
</div>
<div id="dealing-with-nas-and-recoding" class="section level2">
<h2>Dealing with NAs and recoding</h2>
<p>R objects can have a value of NA. This is how R represents missing
data.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>z <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="cn">NA</span>, <span class="dv">7</span>)</span></code></pre></div>
<p>NA values are common in real-world data but can cause trouble, for
example</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">sum</span>(z) <span class="co"># result is NA</span></span></code></pre></div>
<p>Some functions can be told to ignore NA values.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">sum</span>(z, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># result is equal to 4 + 5 + 7</span></span></code></pre></div>
<p>You can find NAs using the <code>is.na()</code> function, and then
remove them</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">is.na</span>(z)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>z_nona <span class="ot">=</span> z[<span class="sc">!</span><span class="fu">is.na</span>(z)] <span class="co"># note the use of the not operator !</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="fu">sum</span>(z)</span></code></pre></div>
<p>If you remove records with NAs be warned: the average of a value
excluding NAs may not be representative.</p>
</div>
<div id="changing-class" class="section level2">
<h2>Changing class</h2>
<p>Sometimes you may want to change the class of an object. This is
called class coercion, and can be done with functions such as
<code>as.logical()</code>, <code>as.numeric()</code> and
<code>as.matrix()</code>.</p>
<ol style="list-style-type: decimal">
<li>Coerce the <code>vehicle_type</code> column of <code>crashes</code>
to the class <code>character</code>.</li>
<li>Coerce the <code>crashes</code> object into a matrix. What happened
to the values?</li>
<li><strong>Bonus:</strong> What is the difference between the output of
<code>summary()</code> on <code>character</code> and <code>factor</code>
variables?</li>
</ol>
</div>
<div id="recoding-values" class="section level2">
<h2>Recoding values</h2>
<p>Often it is useful to ‘recode’ values. In the raw STATS19 files, for
example, -1 means NA. There are many ways to recode values in R, the
simplest and most mature of which is the use of factors, as shown
below:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>z <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>l <span class="ot">=</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>) <span class="co"># labels in ascending order</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>z_factor <span class="ot">=</span> <span class="fu">factor</span>(z, <span class="at">labels =</span> l)</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>z_charcter <span class="ot">=</span> <span class="fu">as.character</span>(z_factor)</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>z_charcter</span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Recode <code>z</code> to Slight, Serious and Fatal for 1:3
respectively.</li>
<li>Bonus: read the help file at <code>?dplyr::case_when</code> and try
to recode the values using this function.</li>
</ol>
</div>
<div id="now-you-are-ready-to-use-r" class="section level2">
<h2>Now you are ready to use R</h2>
<p><strong>Bonus: reproduce the following plot</strong></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>eyes <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">2.3</span>, <span class="dv">4</span>, <span class="fl">3.7</span>, <span class="dv">4</span>)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>eyes <span class="ot">=</span> <span class="fu">matrix</span>(eyes, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>mouth <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="fl">2.5</span>, <span class="fl">1.3</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="fl">3.5</span>, <span class="fl">1.3</span>, <span class="dv">4</span>, <span class="dv">2</span>)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>mouth <span class="ot">=</span> <span class="fu">matrix</span>(mouth, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T)</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="fu">plot</span>(eyes, <span class="at">type =</span> <span class="st">&quot;p&quot;</span>, <span class="at">main =</span> <span class="st">&quot;RRR!&quot;</span>, <span class="at">cex =</span> <span class="dv">2</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>))</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="fu">lines</span>(mouth, <span class="at">type =</span> <span class="st">&quot;l&quot;</span>, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div id="r-packages" class="section level1">
<h1>R Packages</h1>
<div id="what-are-packages" class="section level2">
<h2>What are packages?</h2>
<p>R has over 15,000 packages (effectively plugins for base R),
extending it in almost every direction of statistics and computing.
Packages provide additional functions, data and documentation. They are
very often written by subject-matter experts and therefore tend to fit
well with the workflow of the analyst in that particular specialism.
There are two main stages to using a package: installing it and loading
it. A third stage is updating it, this is also important.</p>
<!-- installing it... -->
<p>Install new packages from <a href="https://cran.r-project.org/">The
Comprehensive R Archive Network</a> with the command
<code>install.packages()</code> (or
<code>remotes::install_github()</code> to install from GitHub). Update
packages with the command <code>update.package()</code> or in Tools &gt;
Check for Package Updates in RStudio. You only need to install a package
once. <!-- **Note: avoid `install.packages()` within a script** -->
<!-- Packages only need to be installed once. -->
<!-- You can use `remotes::install_cran()` or `remotes::install_github()` to only install a package if it is not yet installed and up-to-date (note: you only need to use one of these): --></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;sf&quot;</span>)</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="co"># remotes::install_github(&quot;r-spatial/sf&quot;)</span></span></code></pre></div>
<!-- now talk about loading packages -->
<p>Installed packages are loaded with the command
<code>library()</code>. Usually, the package will load silently. In some
cases the package will provide a message, as illustrated below.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code></pre></div>
<p>To use a function in a package without first loading the package, use
double colons, as shown below (this calls the <code>tibble()</code>
function from the <code>tibble</code> package).</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>crashes_tibble <span class="ot">=</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>  vehicle_type,</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>  casualty_type,</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>  casualty_age,</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>  dark</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>)</span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Take a look in the Packages tab in the Files pane in RStudio (bottom
right by default).</li>
<li>What version of the <code>stats19</code> package is installed on
your computer?</li>
<li>Run the command <code>update.packages()</code>. What happens?
Why?</li>
</ol>
</div>
<div id="ggplot2" class="section level2">
<h2>ggplot2</h2>
<p>Let’s take a look at a particular package. <code>ggplot2</code> is a
generic plotting package that is part of the <a href="https://www.tidyverse.org/">‘tidyverse’</a> meta-package, which is
an “opinionated collection of R packages designed for data science”. All
packages in the tidyverse “share an underlying design philosophy,
grammar, and data structures”. <code>ggplot2</code> is flexible,
popular, and has dozens of add-on packages which build on it, such as
<code>gganimate</code>. To plot non-spatial data, it works as follows
(see figure below, left for result):</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="fu">ggplot</span>(crashes) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> casualty_type, <span class="at">y =</span> casualty_age))</span></code></pre></div>
<p>Note that the <code>+</code> operator adds layers onto one
another.</p>
<ol style="list-style-type: decimal">
<li>Install a package that build on <code>ggplot2</code> that begins
with with <code>gg</code>. Hint: enter <code>install.packages(gg)</code>
and hit Tab when your cursor is between the <code>g</code> and the
<code>)</code>.</li>
<li>Open a help page in the newly installed package with the
<code>?package_name::function()</code> syntax.</li>
<li>Attach the package.</li>
<li><strong>Bonus:</strong> try using functionality from the new ‘gg’
package building on the example above to create plots like those shown
below (hint: the right plot below uses the economist theme from the
<code>ggthemes</code> package, try other themes).</li>
</ol>
</div>
<div id="dplyr-and-pipes" class="section level2">
<h2>dplyr and pipes</h2>
<p>Another useful package in the tidyverse is <code>dplyr</code>. It
provides functions for manipulating data frames and using the pipe
operator <code>%&gt;%</code>. The pipe puts the output of one command
into the first argument of the next, as shown below (note the results
are the same):</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="fu">class</span>(crashes)       </span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>crashes <span class="sc">%&gt;%</span> <span class="fu">class</span>()</span></code></pre></div>
<p>Useful <code>dplyr</code> functions are demonstrated below.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>crashes <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>  <span class="fu">filter</span>(casualty_age <span class="sc">&gt;</span> <span class="dv">50</span>) <span class="co"># filter rows</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>crashes <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>  <span class="fu">select</span>(casualty_type) <span class="co"># select just one column</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>crashes <span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>  <span class="fu">group_by</span>(dark) <span class="sc">%&gt;%</span> </span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_age =</span> <span class="fu">mean</span>(casualty_age))</span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Use <code>dplyr</code> to filter row in which
<code>casualty_age</code> is less than 18, and then 28.</li>
<li>Use the <code>arrange</code> function to sort the
<code>crashes</code> object in descending order of age (hint: see the
<code>?arrange</code> help page).</li>
<li>Read the help page of <code>dplyr::mutate()</code>. What does the
function do?</li>
<li>Use the mutate function to create a new variable,
<code>birth_year</code>, in the <code>crashes</code> data.frame which is
defined as the current year minus their age.</li>
<li><strong>Bonus:</strong> Use the <code>%&gt;%</code> operator to
filter the output from the previous exercise so that only observations
with <code>birth_year</code> after 1969 are returned.</li>
</ol>
</div>
</div>
<div id="temporal-data" class="section level1">
<h1>Temporal data</h1>
<p>For the analysis and manipulation of temporal data we will first load
the R package <code>lubridate</code>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span></code></pre></div>
<p>The simplest example of a Date object that we can analyze is just the
current date, i.e.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="fu">today</span>()</span></code></pre></div>
<p>We can manipulate this object using several <code>lubridate</code>
functions to extract the current day, month, year, weekday and so
on…</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">today</span>()</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="fu">day</span>(x)</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a><span class="fu">month</span>(x)</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a><span class="fu">year</span>(x)</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a><span class="fu">weekdays</span>(x)</span></code></pre></div>
<p>Exercises:</p>
<ol style="list-style-type: decimal">
<li>Look at the help page of the function <code>month</code> to see how
it is possible to extract the current month as character vector</li>
<li>Look at other functions in lubridate to extract the current weekday
as a number, the week of year and the day of the year</li>
</ol>
<p>Date variables are often stored simply as a character vectors. This
is a problem, since R is not always smart enough to distinguish between
character vectors representing Dates. <code>lubridate</code> provides
functions that can translate a wide range of date encodings such as
<code>ymd()</code>, which extracts the Year Month and Day from a
character string, as demonstrated below.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="fu">as.Date</span>(<span class="st">&quot;2019-10-17&quot;</span>) <span class="co"># works</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="fu">as.Date</span>(<span class="st">&quot;2019 10 17&quot;</span>) <span class="co"># fails</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="fu">ymd</span>(<span class="st">&quot;2019 10 17&quot;</span>) <span class="co"># works</span></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="fu">dmy</span>(<span class="st">&quot;17/10/2019&quot;</span>) <span class="co"># works</span></span></code></pre></div>
<p>Import function such as <code>read_csv</code> try to recognize the
Date variables. Sometimes this fails. You can manually create Date
objects, as shown below.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;2009-01-01&quot;</span>, <span class="st">&quot;2009-02-02&quot;</span>, <span class="st">&quot;2009-03-03&quot;</span>)</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>x_date <span class="ot">=</span> <span class="fu">ymd</span>(x)</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>x_date</span></code></pre></div>
<p>Exercises:</p>
<ol style="list-style-type: decimal">
<li>Extract the day, the year-day, the month and the weekday (as a
non-abbreviated character vector) of each element of
<code>x_date</code>.</li>
<li>Convert <code>&quot;09/09/93&quot;</code> into a date object and extract its
weekday.</li>
<li><strong>Bonus:</strong> Read the help page of <code>as.Date</code>
and <code>strptime</code> for further details on base R functions for
dates.</li>
<li><strong>Bonus:</strong> Read the Chapter 16 of <a href="https://r4ds.had.co.nz/dates-and-times.html">R for Data Science
book</a> for further details on <code>lubridate</code> package.</li>
</ol>
<p>We can use Dates also for subsetting events in a dataframe. For
example, if we define <code>x_date</code> as before and add it to the
<code>crash</code> dataset, i.e.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>crashes<span class="sc">$</span>casualty_day <span class="ot">=</span> x_date</span></code></pre></div>
<p>then we can subset events using Dates. For example</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="fu">filter</span>(crashes, <span class="fu">day</span>(casualty_day) <span class="sc">&lt;</span> <span class="dv">7</span>) <span class="co"># the events that ocurred in the first week of the month</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="fu">filter</span>(crashes, <span class="fu">weekdays</span>(casualty_day) <span class="sc">==</span> <span class="st">&quot;Monday&quot;</span>) <span class="co"># the events occurred on monday</span></span></code></pre></div>
<p>Exercises:</p>
<ol style="list-style-type: decimal">
<li>Select only the events (rows in <code>crashes</code>) that occurred
in January</li>
<li>Select only the events that ocurred in an odd year-day</li>
<li>Select only the events that ocurred in a leap-year (HINT: check the
function <code>leap_year</code>)</li>
<li>Select only the events that ocurred during the weekend or in
June</li>
<li>Select only the events that ocurred during the weekend and in
June</li>
<li>Count how many events ocurred during each day of the week.</li>
</ol>
<p>Now we’ll take a look at the time components of a Date. Using the
function <code>hms</code> (acronym for Hour Minutes Seconds) and its
subfunctions such as <code>hm</code> or <code>ms</code>, we can parse a
character vector representing several times as an Hour object (which is
tecnically called a Period object).</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;18:23:35&quot;</span>, <span class="st">&quot;00:00:01&quot;</span>, <span class="st">&quot;12:34:56&quot;</span>)</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>x_hour <span class="ot">=</span> <span class="fu">hms</span>(x)</span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>x_hour</span></code></pre></div>
<p>We can manipulate these objects using several <code>lubridate</code>
functions to extract the hour component, the minutes and so on:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="fu">hour</span>(x_hour)</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a><span class="fu">minute</span>(x_hour)</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="fu">second</span>(x_hour)</span></code></pre></div>
<p>If the Hour data do not specify the seconds, then we just have to use
a subfunction of <code>hms</code>, namely <code>hm</code>, and
everything works as before.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;18:23&quot;</span>, <span class="st">&quot;00:00&quot;</span>, <span class="st">&quot;12:34&quot;</span>)</span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>(<span class="at">x_hour =</span> <span class="fu">hm</span>(x))</span></code></pre></div>
<p>We can use Hour data also for subsetting events, like we did for
Dates. Let’s add a new column to crashes data,</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>crashes<span class="sc">$</span>casualty_hms <span class="ot">=</span> <span class="fu">hms</span>(<span class="fu">c</span>(<span class="st">&quot;18:23:35&quot;</span>, <span class="st">&quot;00:00:01&quot;</span>, <span class="st">&quot;12:34:56&quot;</span>))</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>crashes<span class="sc">$</span>casualty_hour <span class="ot">=</span> <span class="fu">hour</span>(crashes<span class="sc">$</span>casualty_hms)</span></code></pre></div>
<p>Exercises:</p>
<ol style="list-style-type: decimal">
<li>Filter only the events that ocurred after midday (i.e. the PM
events). Hint: your answer may include <code>&gt;= 12</code>.</li>
<li>Filter only the events that ocurred between 15:00 and 19:00
<!-- 1. Round all hours to the next hour. Hint: Look at the help page of the `round_date` function.  --></li>
<li><strong>Bonus (difficult):</strong> run the following code, which
downloades data for car crashes occurred during 2022.</li>
</ol>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="fu">library</span>(stats19)</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>crashes_2022 <span class="ot">=</span> stats19<span class="sc">::</span><span class="fu">get_stats19</span>(<span class="at">year =</span> <span class="dv">2022</span>, <span class="at">type =</span> <span class="st">&quot;ac&quot;</span>)</span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a>crashes_2022</span></code></pre></div>
<p>Extract the weekday from the variable called <code>date</code>. How
many crashes happened on Monday?</p>
<p><strong>Advanced challenge:</strong> calculate how many crashes
occurred for each day of the week. Then plot it with ggplot2. Repeat the
same exercises extracting the hour of the car accident from the variable
called time. How would you combine the two informations in a single
plot?</p>
</div>
<div id="spatial-data" class="section level1">
<h1>Spatial data</h1>
<div id="sf-objects" class="section level2">
<h2>sf objects</h2>
<p>All road crashes happen somewhere and, in the UK at least, all
collisions recorded by the police are given geographic coordinates,
something that can help prioritise interventions to save lives by
intervening in and around ‘crash hotspots’. R has strong geographic data
capabilities, with the <code>sf</code> package provides a generic class
for spatial vector data: points, lines and polygons, are represented in
<code>sf</code> objects as a special ‘geometry column’, typically called
‘geom’ or ‘geometry’, extending the data frame class we’ve already seen
in <code>crashes</code>.</p>
<p>Create an <code>sf</code> data frame called <code>crashes_sf</code>
as follows:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># load the sf package for working with spatial data</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>crashes_sf <span class="ot">=</span> crashes <span class="co"># create copy of crashes dataset</span></span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a>crashes_sf<span class="sc">$</span>longitude <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.3</span>, <span class="sc">-</span><span class="fl">1.2</span>, <span class="sc">-</span><span class="fl">1.1</span>)</span>
<span id="cb36-4"><a href="#cb36-4" tabindex="-1"></a>crashes_sf<span class="sc">$</span>latitude <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">50.7</span>, <span class="fl">50.7</span>, <span class="fl">50.68</span>)</span>
<span id="cb36-5"><a href="#cb36-5" tabindex="-1"></a>crashes_sf <span class="ot">=</span> <span class="fu">st_as_sf</span>(crashes_sf, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;longitude&quot;</span>, <span class="st">&quot;latitude&quot;</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb36-6"><a href="#cb36-6" tabindex="-1"></a><span class="co"># plot(crashes_sf[1:4]) # basic plot</span></span>
<span id="cb36-7"><a href="#cb36-7" tabindex="-1"></a><span class="co"># mapview::mapview(crashes_sf) # for interactive map</span></span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Plot only the geometry column of <code>crashes_sf</code> (hint: the
solution may contain <code>$geometry</code>). If the result is like the
figure below, congratulations, it worked!).</li>
<li>Plot <code>crashes_sf</code>, only showing the age variable.</li>
<li>Plot the 2<sup>nd</sup> and 3<sup>rd</sup> crashes, showing which
happened in the dark.</li>
<li><strong>Bonus</strong>: How far are the points apart (hint:
<code>sf</code> functions begin with <code>st_</code>)?</li>
<li><strong>Bonus</strong>: Near which settlement did the tank runover
the cat?</li>
</ol>
</div>
<div id="reading-and-writing-spatial-data" class="section level2">
<h2>Reading and writing spatial data</h2>
<p>You can read and write spatial data with <code>read_sf()</code> and
<code>write_sf()</code>, as shown below (see <code>?read_sf</code>).</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="fu">write_sf</span>(zones, <span class="st">&quot;zones.geojson&quot;</span>) <span class="co"># save geojson file</span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a><span class="fu">write_sf</span>(zones, <span class="st">&quot;zmapinfo&quot;</span>, <span class="at">driver =</span> <span class="st">&quot;MapInfo file&quot;</span>)</span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a><span class="fu">read_sf</span>(<span class="st">&quot;zmapinfo&quot;</span>) <span class="co"># read in mapinfo file</span></span></code></pre></div>
<p>See <a href="https://r.geocompx.org/read-write.html">Chapter 6</a> of
Geocomputation with R for further information.</p>
</div>
<div id="sf-polygons" class="section level2">
<h2>sf polygons</h2>
<p>Note: the code beyond this point is not evaluated in the
vignette:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p><code>sf</code> objects can also represent administrative zones. This
is illustrated below with reference to <code>zones</code>, a spatial
object representing the Isle of Wight, that we will download using the
<code>pct</code> package (note: the <code>[1:9]</code> appended to the
function selects only the first 9 columns).</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>zones <span class="ot">=</span> pct<span class="sc">::</span><span class="fu">get_pct_zones</span>(<span class="st">&quot;isle-of-wight&quot;</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>]</span></code></pre></div>
<ol style="list-style-type: decimal">
<li>What is the class of the <code>zones</code> object?</li>
<li>What are its column names?</li>
<li>Print its first 2 rows and columns 6:8 (the result is below).</li>
</ol>
</div>
<div id="spatial-subsetting-and-sf-plotting" class="section level2">
<h2>Spatial subsetting and sf plotting</h2>
<p>Like index and value subsetting, spatial subsetting can be done with
the <code>[</code> notation. Subset the <code>zones</code> that contain
features in <code>crashes_sf</code> as follows:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a>zones_containing_crashes <span class="ot">=</span> zones[crashes_sf, ]</span></code></pre></div>
<p>To plot a new layer on top of an existing <code>sf</code> plot, use
the <code>add = TRUE</code> argument. Remember to plot only the
<code>geometry</code> column of objects to avoid multiple maps. Colours
can be set with the <code>col</code> argument.</p>
<ol style="list-style-type: decimal">
<li>Plot the geometry of the zones, with the zones containing crashes
overlaid on top in red.</li>
<li>Plot the zone containing the 2<sup>nd</sup> crash in blue.</li>
<li><strong>Bonus:</strong> plot all zones that intersect with a zone
containing crashes, with the actual crash points plotted in black.</li>
</ol>
</div>
<div id="geographic-joins" class="section level2">
<h2>Geographic joins</h2>
<p>Geographic joins involve assigning values from one object to a new
column in another, based on the geographic relationship between them.
With <code>sf</code> objects it works as follows:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>zones_joined <span class="ot">=</span> <span class="fu">st_join</span>(zones[<span class="dv">1</span>], crashes_sf)</span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Plot the <code>casualty_age</code> variable of the new
<code>zones_joined</code> object (see the figure below to verify the
result).</li>
<li>How many zones are returned in the previous command?</li>
<li>Select only the <code>geo_code</code> column from the
<code>zones</code> and the <code>dark</code> column from
<code>crashes_sf</code> and use the <code>left = FALSE</code> argument
to return only zones in which crashes occured. Plot the result.</li>
</ol>
<p>See <a href="https://r.geocompx.org/spatial-operations.html">Chapter
4</a> of Geocomputation with R <span class="citation">(Lovelace,
Nowosad, and Muenchow 2019)</span> for further information on geographic
joins.</p>
</div>
<div id="crss" class="section level2">
<h2>CRSs</h2>
<p>Get and set Coordinate Reference Systems (CRSs) with the command
<code>st_crs()</code>. Transform CRSs with the command
<code>st_transform()</code>, as demonstrated in the code chunk below,
which converts the ‘lon/lat’ geographic CRS of <code>crashes_sf</code>
into the projected CRS of the British National Grid:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a>crashes_osgb <span class="ot">=</span> <span class="fu">st_transform</span>(crashes_sf, <span class="dv">27700</span>)</span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Try to subset the zones with the <code>crashes_osgb</code>. What
does the error message say?</li>
<li>Create <code>zones_osgb</code> by transforming the
<code>zones</code> object.</li>
<li><strong>Bonus:</strong> use <code>st_crs()</code> to find out the
units measurement of the British National Grid?</li>
</ol>
<p>For more information on CRSs see <a href="https://r.geocompx.org/reproj-geo-data.html">Chapter 6</a> of
Geocompuation with R.</p>
</div>
<div id="buffers" class="section level2">
<h2>Buffers</h2>
<p>Buffers are polygons surrounding geometries of a (usually) fixed
distance. Currently buffer operations in R only work on objects with
projected CRSs.</p>
<ol style="list-style-type: decimal">
<li>Find out and read the help page of <code>sf</code>’s buffer
function.</li>
<li>Create an object called <code>crashes_1km_buffer</code> representing
the area within 1 km of the crashes.</li>
<li><strong>Bonus:</strong> try creating buffers on the geographic
version of the <code>crashes_sf</code> object. What happens?</li>
</ol>
</div>
<div id="attribute-operations-on-sf-objects" class="section level2">
<h2>Attribute operations on sf objects</h2>
<p>Because <code>sf</code> objects are <code>data.frame</code>s, we can
do non-spatial operations on them. Try the following attribute
operations on the <code>zones</code> data.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="co"># load example dataset if it doesn&#39;t already exist</span></span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a>zones <span class="ot">=</span> pct<span class="sc">::</span><span class="fu">get_pct_zones</span>(<span class="st">&quot;isle-of-wight&quot;</span>)</span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a>sel <span class="ot">=</span> zones<span class="sc">$</span>all <span class="sc">&gt;</span> <span class="dv">3000</span>  <span class="co"># create a subsetting object</span></span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a>zones_large <span class="ot">=</span> zones[sel, ] <span class="co"># subset areas with a popualtion over 100,000</span></span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a>zones_2 <span class="ot">=</span> zones[zones<span class="sc">$</span>geo_name <span class="sc">==</span> <span class="st">&quot;Isle of Wight 002&quot;</span>,] <span class="co"># subset based on &#39;equality&#39; query</span></span>
<span id="cb43-6"><a href="#cb43-6" tabindex="-1"></a>zones_first_and_third_column <span class="ot">=</span> zones[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)]</span>
<span id="cb43-7"><a href="#cb43-7" tabindex="-1"></a>zones_just_all <span class="ot">=</span> zones[<span class="st">&quot;all&quot;</span>]</span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Practice subsetting techniques you have learned on the
<code>sf data.frame</code> object <code>zones</code>:
<ol style="list-style-type: decimal">
<li>Create an object called <code>zones_small</code> which contains only
regions with less than 3000 people in the <code>all</code> column</li>
<li>Create a selection object called <code>sel_high_car</code> which is
<code>TRUE</code> for regions with above median numbers of people who
travel by car and <code>FALSE</code> otherwise</li>
<li>Create an object called <code>zones_foot</code> which contains only
the foot attribute from <code>zones</code></li>
<li>Bonus: plot <code>zones_foot</code> using the function
<code>plot</code> to show where walking is a popular mode of travel to
work</li>
<li>Bonus: bulding on your answers to previous questions, use
<code>filter()</code> from the <code>dplyr</code> package to subset
small regions where car use is high.</li>
</ol></li>
<li>Bonus: What is the population density of each region (hint: you may
need to use the functions <code>st_area()</code>,
<code>as.numeric()</code> and use the ‘all’ column)?</li>
<li>Bonus: Which zone has the highest percentage of people who
cycle?</li>
</ol>
</div>
<div id="matching-roads-to-crashes" class="section level2">
<h2>Matching roads to crashes</h2>
<p>I think you forgot something here. For example we could introduce
<code>st_nearest_feature</code>? Or counting using
<code>st_within</code> and <code>st_buffer</code>.</p>
</div>
</div>
<div id="visualising-spatial-datasets" class="section level1">
<h1>Visualising spatial datasets</h1>
<p>So far we have used the <code>plot()</code> function to make maps.
That’s fine for basic visualisation, but for publication-quality maps,
we recommend using <code>tmap</code> (see Chapter 8 of Geocomputation
with R for reasons and alternatives). Load the package as follows:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&quot;plot&quot;</span>)</span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Create the following plots using <code>plot()</code> and
<code>tm_shape() + tm_polygons()</code> functions (note: the third
figure relies on setting <code>tmap_mode(&quot;view&quot;)</code>.</li>
<li>Add an additional layer to the interactive map showing the location
of crashes, using marker and dot symbols.</li>
<li>Bonus: Change the default basemap (hint: you may need to search in
the package documentation or online for the solution).</li>
</ol>
</div>
<div id="analysing-point-data-from-stats19" class="section level1">
<h1>Analysing point data from stats19</h1>
<p>Based on the saying “don’t run before you can walk”, we’ve learned
the vital foundations of R before tackling a real dataset. Temporal and
spatial attributes are key to road crash data, hence the emphasis on
<code>lubridate</code> and <code>sf</code>. Visualisation is key to
understanding and policy influence, which is where <code>tmap</code>
comes in. With these solid foundations, plus knowledge of how to ask for
help (read R’s internal help functions, ask colleagues, create new
comments on online forums/GitHub, generally in that order of priority),
you are ready to test the methods on some real data.</p>
<p>Before doing so, take a read of the <code>stats19</code> vignette,
which can be launched as follows:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="fu">vignette</span>(<span class="at">package =</span> <span class="st">&quot;stats19&quot;</span>) <span class="co"># view all vignettes available on stats19</span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a><span class="fu">vignette</span>(<span class="st">&quot;stats19&quot;</span>) <span class="co"># view the introductory vignette</span></span></code></pre></div>
<p>This should now be sufficient to tackle the following exercises:</p>
<ol style="list-style-type: decimal">
<li>Download and plot all crashes reported in Great Britain in 2018
(hint: see <a href="https://docs.ropensci.org/stats19/articles/stats19.html">the
stats19 vignette</a>)</li>
<li>Find the function in the <code>stats19</code> package that converts
a <code>data.frame</code> object into an <code>sf</code> data frame. Use
this function to convert the road crashes into an <code>sf</code>
object, called <code>crashes_sf</code>, for example.</li>
<li>Filter crashes that happened in the Isle of Wight based on attribute
data (hint: the relevant column contains the word
<code>local</code>)</li>
<li>Filter crashes happened in the Isle of Wight using geographic
subsetting (hint: remember <code>st_crs()</code>?)</li>
<li><strong>Bonus:</strong> Which type of subsetting yielded more
results and why?</li>
<li><strong>Bonus:</strong> how many crashes happened in each zone?</li>
<li>Create a new column called <code>month</code> in the crash data
using the function <code>lubridate::month()</code> and the
<code>date</code> column.</li>
<li>Create an object called <code>a_zones_may</code> representing all
the crashes that happened in the Isle of Wight in the month of May</li>
<li>Bonus: Calculate the average (<code>mean</code>) speed limit
associated with each crash that happened in May across the zones of the
Isle of Wight (the result is shown in the map)</li>
</ol>
</div>
<div id="analysing-crash-data-on-road-networks" class="section level1">
<h1>Analysing crash data on road networks</h1>
<p>Road network data can be accessed from a range of sources, including
OpenStreetMap (OSM) and Ordnance Survey. We will use some OSM data from
the Ilse of Wight, which can be loaded as follows:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a>u <span class="ot">=</span> <span class="st">&quot;https://github.com/ropensci/stats19/releases/download/1.1.0/roads_key.Rds&quot;</span></span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a>roads_wgs <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">url</span>(u))</span>
<span id="cb46-3"><a href="#cb46-3" tabindex="-1"></a>roads <span class="ot">=</span> roads_wgs <span class="sc">%&gt;%</span> <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">27700</span>)</span></code></pre></div>
<p>You should already have road crashes for the Isle of Wight from the
previous stage. If not, load crash data as follows:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a>u <span class="ot">=</span> <span class="st">&quot;https://github.com/ropensci/stats19/releases/download/1.1.0/car_collisions_2022_iow.Rds&quot;</span></span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a>crashes_iow <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">url</span>(u))</span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Plot the roads with the crashes overlaid.</li>
<li>Create a buffer around the roads with a distance of 200 m.</li>
<li>How many crashes fall outside the buffered roads?</li>
<li>Bonus: Use the <code>aggregate()</code> function to identify how
many crashes happened per segment and plot the result (hint: see
<code>?aggregate.sf</code> and take a read of Section <a href="https://r.geocompx.org/spatial-operations.html">4.2.5</a> of
Geocomputation with R) with <code>tmap</code> and plot the crashes that
happened outside the road buffers on top.</li>
</ol>
<div style="page-break-after: always;"></div>
</div>
<div id="bonus-exercises" class="section level1">
<h1>Bonus exercises</h1>
<p>Identify a region and zonal units of interest from <a href="https://geoportal.statistics.gov.uk/" class="uri">https://geoportal.statistics.gov.uk/</a> or from the object
<code>police_boundaries</code> in the <code>stats19</code> package.</p>
<ol style="list-style-type: decimal">
<li>Read them into R as an <code>sf</code> object</li>
<li>Create a map showing the number of crashes in each zone</li>
<li>Identify the average speed limit associated with crashes in each
zone</li>
<li>Identify an interesting question you can ask to the data and use
exploratory data analysis to find answers</li>
<li>Check another <a href="https://github.com/agila5/leeds_seminar">related project</a> for
further information on smoothing techniques of counts on a linear
network.
<!-- 1. Take a look at the code in [the file iow_example.R in the inst directory in the stats19 repo](https://github.com/ropensci/stats19/blob/master/inst/iow_example.R). Run it to create smoothed estimates of crash frequency on the road network (see [code in the  GitHub repo](https://github.com/agila5/leeds_seminar/blob/master/examples.R) for further information on these preliminary methods). --></li>
</ol>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-lovelace_reproducible_2020" class="csl-entry">
Lovelace, Robin. 2020. <span>“Reproducible Road Safety Research with
<span>R</span>.”</span> <span>Royal Automotive Club Foundation</span>.
</div>
<div id="ref-lovelace_stats19_2019" class="csl-entry">
Lovelace, Robin, Malcolm Morgan, Layik Hama, Mark Padgham, and M
Padgham. 2019. <span>“Stats19 <span>A</span> Package for Working with
Open Road Crash Data.”</span> <em>Journal of Open Source Software</em> 4
(33): 1181. <a href="https://doi.org/10.21105/joss.01181">https://doi.org/10.21105/joss.01181</a>.
</div>
<div id="ref-lovelace_geocomputation_2019" class="csl-entry">
Lovelace, Robin, Jakub Nowosad, and Jannes Muenchow. 2019.
<em>Geocomputation with <span>R</span></em>. <span>CRC Press</span>.
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
